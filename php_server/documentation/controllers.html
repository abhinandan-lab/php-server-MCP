<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controllers - PHP Light Framework</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
</head>
<body>
    <nav class="sidebar">
        <div class="sidebar-header">
            <h3>PHP Light Framework</h3>
            <span class="version">v1.0.0</span>
        </div>
        <ul class="nav-links">
            <li><a href="index.html">🏠 Home</a></li>
            <li><a href="installation.html">📦 Installation</a></li>
            <li><a href="routing.html">🛣️ Routing</a></li>
            <li><a href="controllers.html" class="active">🎛️ Controllers</a></li>
            <li><a href="validation.html">🔒 Validation & Security</a></li>
            <li><a href="database.html">💾 Database</a></li>
            <li><a href="debugging.html">🐛 Debugging</a></li>
            <li><a href="exceptions.html">⚠️ Error Handling</a></li>
            <li><a href="examples.html">📚 Examples</a></li>
            <li><a href="reference.html">📖 API Reference</a></li>
        </ul>
        <div class="sidebar-footer">
            <a href="/api/docs" target="_blank" class="demo-link">🚀 Live Demo</a>
        </div>
    </nav>

    <main class="content">
        <div class="container">
            <header class="page-header">
                <nav class="breadcrumb">
                    <a href="index.html">Home</a> > Controllers
                </nav>
                <h1>🎛️ Controllers</h1>
                <p>Request handling and response methods</p>
            </header>

            <section class="basecontroller">
                <h2>🏗️ BaseController</h2>
                <p>All controllers extend <code>BaseController</code> which provides common functionality:</p>
                
                <pre><code class="language-php">&lt;?php

namespace App\Controllers;

class UserController extends BaseController 
{
    // Database connection automatically available as $this->conn
    // Validation and response methods inherited
    
    public function getUser($id) 
    {
        // Validate input
        if (!is_numeric($id)) {
            $this->sendError('Invalid user ID', 400);
            return;
        }
        
        // Query database
        $user = RunQuery([
            'conn' => $this->conn,
            'query' => 'SELECT * FROM users WHERE id = :id',
            'params' => [':id' => $id]
        ]);
        
        if (empty($user)) {
            $this->sendError('User not found', 404);
            return;
        }
        
        $this->sendSuccess('User retrieved successfully', $user[0]);
    }
}</code></pre>
            </section>

            <section class="response-methods">
                <h2>📤 Response Methods</h2>
                
                <div class="method">
                    <h3>Success Responses</h3>
                    <pre><code class="language-php">// Basic success response
$this->sendSuccess('Operation completed', $data);

// Success with extra headers
$this->sendSuccess('User created', $userData, [
    'Location' => '/api/users/' . $userId
]);</code></pre>
                </div>

                <div class="method">
                    <h3>Error Responses</h3>
                    <pre><code class="language-php">// Generic error
$this->sendError('Something went wrong', 500);

// Validation error
$this->sendValidationError('Validation failed', [
    'email' => 'Email is required',
    'password' => 'Password must be at least 8 characters'
]);

// Server error
$this->sendServerError('Database connection failed');</code></pre>
                </div>
            </section>

            <section class="request-handling">
                <h2>📥 Request Handling</h2>
                
                <pre><code class="language-php">public function createUser() 
{
    try {
        // Get and validate request data
        $data = $this->validateRequest([
            'name' => 'required|min:2|max:50',
            'email' => 'required|email',
            'password' => 'required|min:8'
        ]);
        
        // Process the data (automatically sanitized)
        $userId = $this->createUserInDatabase($data);
        
        $this->sendSuccess('User created successfully', [
            'user_id' => $userId,
            'email' => $data['email']
        ]);
        
    } catch (ValidationException $e) {
        $this->sendValidationError($e->getMessage(), $e->getValidationErrors());
    }
}</code></pre>
            </section>

            <section class="parameter-access">
                <h2>📨 Parameter Access</h2>
                
                <div class="param-type">
                    <h3>URL Parameters</h3>
                    <p>URL parameters are passed as function arguments:</p>
                    <pre><code class="language-php">// Route: /user/{id}/posts/{postId}
public function getUserPost($id, $postId) 
{
    pp("User ID: $id, Post ID: $postId");
    
    // Use the parameters
    $post = $this->getPostByUserAndId($id, $postId);
}</code></pre>
                </div>

                <div class="param-type">
                    <h3>GET Parameters</h3>
                    <p>Access via $_GET superglobal:</p>
                    <pre><code class="language-php">public function getPosts() 
{
    $page = (int)($_GET['page'] ?? 1);
    $limit = (int)($_GET['limit'] ?? 10);
    $status = $_GET['status'] ?? null;
    
    pp("Page: $page, Limit: $limit, Status: $status");
}</code></pre>
                </div>

                <div class="param-type">
                    <h3>Form Data</h3>
                    <p>Use getRequestData() or validateRequest():</p>
                    <pre><code class="language-php">public function login() 
{
    // Get all request data (GET, POST, JSON)
    $data = $this->getRequestData();
    
    // Or validate with rules
    $data = $this->validateRequest([
        'email' => 'required|email',
        'password' => 'required|min:8'
    ]);
}</code></pre>
                </div>

                <div class="param-type">
                    <h3>JSON Body</h3>
                    <p>JSON data is automatically included in getRequestData():</p>
                    <pre><code class="language-php">public function createUser() 
{
    // JSON automatically parsed and merged
    $data = $this->getRequestData();
    
    // Validate JSON data
    $data = $this->validateRequest([
        'name' => 'required|min:2|max:50',
        'profile' => 'required' // JSON object
    ]);
}</code></pre>
                </div>
            </section>

            <section class="complete-example">
                <h2>📚 Complete Controller Example</h2>
                <pre><code class="language-php">&lt;?php

namespace App\Controllers;

use App\Exceptions\ValidationException;

class PostController extends BaseController
{
    /**
     * Get all posts with pagination and filtering
     * Route: GET /posts?page=1&limit=10&status=published
     */
    public function getPosts()
    {
        $page = max(1, (int)($_GET['page'] ?? 1));
        $limit = min(100, max(1, (int)($_GET['limit'] ?? 10)));
        $status = $_GET['status'] ?? null;
        
        $offset = ($page - 1) * $limit;
        
        // Build dynamic query
        $whereClause = '';
        $params = [':limit' => $limit, ':offset' => $offset];
        
        if ($status) {
            $whereClause = 'WHERE status = :status';
            $params[':status'] = $status;
        }
        
        // Get posts
        $posts = RunQuery([
            'conn' => $this->conn,
            'query' => "SELECT * FROM posts $whereClause ORDER BY created_at DESC LIMIT :limit OFFSET :offset",
            'params' => $params
        ]);
        
        // Get total count
        $totalQuery = $status ? 'SELECT COUNT(*) as count FROM posts WHERE status = :status' : 'SELECT COUNT(*) as count FROM posts';
        $totalParams = $status ? [':status' => $status] : [];
        $total = RunQuery(['conn' => $this->conn, 'query' => $totalQuery, 'params' => $totalParams])[0]['count'];
        
        $this->sendSuccess('Posts retrieved successfully', [
            'posts' => $posts,
            'pagination' => [
                'page' => $page,
                'limit' => $limit,
                'total' => (int)$total,
                'pages' => ceil($total / $limit)
            ]
        ]);
    }
    
    /**
     * Create new post
     * Route: POST /posts
     */
    public function createPost()
    {
        try {
            $data = $this->validateRequest([
                'title' => 'required|min:5|max:200',
                'content' => 'required|min:50',
                'status' => 'alpha'
            ]);
            
            $result = RunQuery([
                'conn' => $this->conn,
                'query' => 'INSERT INTO posts (title, content, status, created_at) VALUES (:title, :content, :status, NOW())',
                'params' => [
                    ':title' => $data['title'],
                    ':content' => $data['content'],
                    ':status' => $data['status'] ?? 'draft'
                ],
                'withSuccess' => true
            ]);
            
            if (isset($result['error'])) {
                $this->sendServerError('Failed to create post');
                return;
            }
            
            $this->sendSuccess('Post created successfully', [
                'post_id' => $result['id'],
                'title' => $data['title'],
                'status' => $data['status'] ?? 'draft'
            ], ['Location' => "/api/posts/{$result['id']}"]);
            
        } catch (ValidationException $e) {
            $this->sendValidationError($e->getMessage(), $e->getValidationErrors());
        } catch (\Exception $e) {
            pp("Error creating post: " . $e->getMessage());
            $this->sendServerError('Internal server error');
        }
    }
    
    /**
     * Get specific post by ID
     * Route: GET /posts/{id}
     */
    public function getPost($id)
    {
        if (!is_numeric($id)) {
            $this->sendError('Invalid post ID', 400);
            return;
        }
        
        $post = RunQuery([
            'conn' => $this->conn,
            'query' => 'SELECT * FROM posts WHERE id = :id',
            'params' => [':id' => $id]
        ]);
        
        if (empty($post)) {
            $this->sendError('Post not found', 404);
            return;
        }
        
        $this->sendSuccess('Post retrieved successfully', $post[0]);
    }
}</code></pre>
            </section>

            <section class="best-practices">
                <h2>✅ Controller Best Practices</h2>
                
                <div class="practice">
                    <h3>🛡️ Always Validate Input</h3>
                    <pre><code class="language-php">// ✅ Good - Validate all inputs
$data = $this->validateRequest([
    'email' => 'required|email',
    'name' => 'required|min:2|max:50'
]);

// ❌ Bad - Using raw input
$email = $_POST['email'];</code></pre>
                </div>

                <div class="practice">
                    <h3>🔍 Handle Errors Gracefully</h3>
                    <pre><code class="language-php">// ✅ Good - Proper error handling
if (!$user) {
    $this->sendError('User not found', 404);
    return;
}

// ❌ Bad - Generic response
if (!$user) {
    $this->sendError('Error');
}</code></pre>
                </div>

                <div class="practice">
                    <h3>📊 Use Debugging</h3>
                    <pre><code class="language-php">// ✅ Good - Debug during development
pp("Processing user ID: $id");
ppp($requestData);

// Will only show when DEBUG_MODE=true</code></pre>
                </div>
            </section>

            <section class="next-steps">
                <h2>🎯 Next Steps</h2>
                <div class="next-links">
                    <a href="validation.html" class="next-link">
                        <strong>🔒 Learn Validation</strong>
                        <span>Secure your endpoints with input validation</span>
                    </a>
                    <a href="database.html" class="next-link">
                        <strong>💾 Database Operations</strong>
                        <span>Work with database queries and migrations</span>
                    </a>
                </div>
            </section>
        </div>
    </main>

    <script src="assets/script.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
</body>
</html>
