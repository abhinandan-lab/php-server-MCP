<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Error Handling - PHP Light Framework</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
</head>
<body>
    <nav class="sidebar">
        <div class="sidebar-header">
            <h3>PHP Light Framework</h3>
            <span class="version">v1.0.0</span>
        </div>
        <ul class="nav-links">
            <li><a href="index.html">🏠 Home</a></li>
            <li><a href="installation.html">📦 Installation</a></li>
            <li><a href="routing.html">🛣️ Routing</a></li>
            <li><a href="controllers.html">🎛️ Controllers</a></li>
            <li><a href="validation.html">🔒 Validation & Security</a></li>
            <li><a href="database.html">💾 Database</a></li>
            <li><a href="debugging.html">🐛 Debugging</a></li>
            <li><a href="exceptions.html" class="active">⚠️ Error Handling</a></li>
            <li><a href="examples.html">📚 Examples</a></li>
            <li><a href="reference.html">📖 API Reference</a></li>
        </ul>
        <div class="sidebar-footer">
            <a href="/api/docs" target="_blank" class="demo-link">🚀 Live Demo</a>
        </div>
    </nav>

    <main class="content">
        <div class="container">
            <header class="page-header">
                <nav class="breadcrumb">
                    <a href="index.html">Home</a> > Error Handling
                </nav>
                <h1>⚠️ Error Handling</h1>
                <p>Exception handling and custom error types</p>
            </header>

            <section class="global-handler">
                <h2>🌐 Global Exception Handler</h2>
                <p>The framework includes a comprehensive global exception handler that catches all unhandled exceptions:</p>
                
                <pre><code class="language-php">// Automatically registered in index.php
ExceptionHandler::register();

// Catches and formats all exceptions as JSON responses
{
    "status": "error",
    "message": "Validation failed",
    "data": {
        "error_type": "validation_error",
        "exception_class": "ValidationException",
        "file": "/api/controllers/UserController.php",
        "line": 45,
        "stack_trace": [...]
    }
}</code></pre>
            </section>

            <section class="built-in-exceptions">
                <h2>🏗️ Built-in Exception Types</h2>
                
                <div class="exception-type">
                    <h3>ValidationException</h3>
                    <p>Thrown when request validation fails:</p>
                    <pre><code class="language-php">// HTTP Status: 422 Unprocessable Entity
throw new ValidationException('Validation failed', [
    'email' => 'Email is required',
    'password' => 'Password must be at least 8 characters'
]);

// Response:
{
    "status": "error",
    "message": "Validation failed",
    "data": {
        "validation_errors": {
            "email": "Email is required",
            "password": "Password must be at least 8 characters"
        }
    }
}</code></pre>
                </div>

                <div class="exception-type">
                    <h3>NotFoundException</h3>
                    <p>Thrown when a resource is not found:</p>
                    <pre><code class="language-php">// HTTP Status: 404 Not Found
throw new NotFoundException('User not found');

// Response:
{
    "status": "error",
    "message": "User not found",
    "data": {
        "error_type": "not_found"
    }
}</code></pre>
                </div>

                <div class="exception-type">
                    <h3>AuthenticationException</h3>
                    <p>Thrown when authentication fails:</p>
                    <pre><code class="language-php">// HTTP Status: 401 Unauthorized
throw new AuthenticationException('Invalid credentials');

// Response:
{
    "status": "error", 
    "message": "Invalid credentials",
    "data": {
        "error_type": "authentication_error"
    }
}</code></pre>
                </div>

                <div class="exception-type">
                    <h3>DatabaseException</h3>
                    <p>Thrown when database operations fail:</p>
                    <pre><code class="language-php">// HTTP Status: 500 Internal Server Error
throw new DatabaseException('Database connection failed');

// Response:
{
    "status": "error",
    "message": "Database connection failed", 
    "data": {
        "error_type": "database_error"
    }
}</code></pre>
                </div>
            </section>

            <section class="using-exceptions">
                <h2>🎯 Using Exceptions in Controllers</h2>
                
                <div class="controller-example">
                    <h3>Controller Exception Handling</h3>
                    <pre><code class="language-php">class UserController extends BaseController
{
    public function getUser($id)
    {
        // Validate input
        if (!is_numeric($id) || $id <= 0) {
            throw new ValidationException('Invalid user ID', [
                'id' => 'User ID must be a positive integer'
            ]);
        }
        
        // Query database
        $user = RunQuery([
            'conn' => $this->conn,
            'query' => 'SELECT * FROM users WHERE id = :id',
            'params' => [':id' => $id]
        ]);
        
        // Handle database errors
        if (isset($user['error'])) {
            throw new DatabaseException('Failed to retrieve user: ' . $user['error']);
        }
        
        // Handle not found
        if (empty($user)) {
            throw new NotFoundException('User not found');
        }
        
        $this->sendSuccess('User retrieved successfully', $user[0]);
    }
    
    public function login()
    {
        try {
            $data = $this->validateRequest([
                'email' => 'required|email',
                'password' => 'required|min:8'
            ]);
            
            $user = $this->authenticateUser($data['email'], $data['password']);
            
            if (!$user) {
                throw new AuthenticationException('Invalid email or password');
            }
            
            $token = $this->generateToken($user);
            
            $this->sendSuccess('Login successful', [
                'user' => $user,
                'token' => $token
            ]);
            
        } catch (ValidationException $e) {
            // This will be handled by global exception handler
            throw $e;
        } catch (\Exception $e) {
            // Log unexpected errors
            error_log("Login error: " . $e->getMessage());
            throw new \Exception('Login failed');
        }
    }
}</code></pre>
                </div>
            </section>

            <section class="custom-exceptions">
                <h2>🔧 Creating Custom Exceptions</h2>
                <p>Create custom exception types for specific use cases:</p>
                
                <div class="custom-exception-example">
                    <h3>Custom Exception Class</h3>
                    <p>Create <code>/api/exceptions/PaymentException.php</code>:</p>
                    <pre><code class="language-php">&lt;?php

namespace App\Exceptions;

class PaymentException extends BaseException
{
    protected int $httpStatusCode = 402;
    protected string $errorType = 'payment_error';
    
    private array $paymentDetails;
    
    public function __construct(string $message, array $paymentDetails = [])
    {
        parent::__construct($message);
        $this->paymentDetails = $paymentDetails;
    }
    
    public function getPaymentDetails(): array
    {
        return $this->paymentDetails;
    }
    
    public function toArray(): array
    {
        $data = parent::toArray();
        $data['payment_details'] = $this->paymentDetails;
        return $data;
    }
}</code></pre>
                </div>

                <div class="custom-usage">
                    <h3>Using Custom Exceptions</h3>
                    <pre><code class="language-php">class PaymentController extends BaseController
{
    public function processPayment()
    {
        try {
            $data = $this->validateRequest([
                'amount' => 'required|numeric|min:0.01',
                'card_token' => 'required'
            ]);
            
            $result = $this->chargeCard($data['amount'], $data['card_token']);
            
            if (!$result['success']) {
                throw new PaymentException(
                    'Payment processing failed',
                    [
                        'transaction_id' => $result['transaction_id'] ?? null,
                        'decline_reason' => $result['decline_reason'] ?? 'Unknown',
                        'amount' => $data['amount']
                    ]
                );
            }
            
            $this->sendSuccess('Payment processed successfully', $result);
            
        } catch (PaymentException $e) {
            // PaymentException will be handled by global handler
            throw $e;
        }
    }
}</code></pre>
                </div>
            </section>

            <section class="error-responses">
                <h2>📤 Error Response Formats</h2>
                
                <div class="response-format">
                    <h3>Standard Error Response</h3>
                    <pre><code class="language-json">{
    "status": "error",
    "message": "Human readable error message",
    "data": {
        "error_type": "validation_error|not_found|authentication_error|etc",
        "exception_class": "ValidationException",
        "file": "/api/controllers/UserController.php",
        "line": 45,
        "stack_trace": [
            "#0 /api/controllers/UserController.php(45): method()",
            "#1 /api/Router.php(123): UserController->getUser()",
            "#2 {main}"
        ]
    }
}</code></pre>
                </div>

                <div class="response-format">
                    <h3>Validation Error Response</h3>
                    <pre><code class="language-json">{
    "status": "error",
    "message": "Validation failed", 
    "data": {
        "validation_errors": {
            "email": ["Email is required", "Email must be valid"],
            "password": ["Password must be at least 8 characters"],
            "name": ["Name is required"]
        },
        "error_type": "validation_error"
    }
}</code></pre>
                </div>

                <div class="response-format">
                    <h3>Custom Exception Response</h3>
                    <pre><code class="language-json">{
    "status": "error",
    "message": "Payment processing failed",
    "data": {
        "error_type": "payment_error",
        "payment_details": {
            "transaction_id": "txn_1234567890",
            "decline_reason": "insufficient_funds",
            "amount": 99.99
        }
    }
}</code></pre>
                </div>
            </section>

            <section class="error-logging">
                <h2>📋 Error Logging</h2>
                <p>The framework automatically logs all exceptions when <code>LOG_ERRORS=true</code>:</p>
                
                <div class="log-example">
                    <h3>Error Log Format</h3>
                    <pre><code class="language-text">[2025-09-30 00:25:15] ValidationException: Validation failed
File: /api/controllers/UserController.php
Line: 23
Validation Errors: {"email":"Email is required","password":"Password must be at least 8 characters"}
Request URI: POST /api/users
IP Address: 192.168.1.100
User Agent: Mozilla/5.0...

[2025-09-30 00:25:45] DatabaseException: Database connection failed  
File: /api/connection.php
Line: 15
Message: SQLSTATE[HY000] [1045] Access denied for user 'root'@'localhost'
Stack Trace:
#0 /api/connection.php(15): PDO->__construct()
#1 /api/controllers/BaseController.php(10): include_once()
#2 {main}</code></pre>
                </div>

                <div class="log-locations">
                    <h3>Log File Locations</h3>
                    <pre><code class="language-text">/api/logs/error.log         # All exceptions
/api/logs/validation.log    # Validation exceptions only
/api/logs/database.log      # Database exceptions only
/api/logs/security.log      # Authentication/security exceptions</code></pre>
                </div>
            </section>

            <section class="testing-exceptions">
                <h2>🧪 Testing Exception Handling</h2>
                <p>The framework includes a test endpoint to verify exception handling:</p>
                
                <pre><code class="language-php">// Test different exception types
GET /api/test-exception?type=validation
GET /api/test-exception?type=database  
GET /api/test-exception?type=notfound
GET /api/test-exception?type=generic

// In AuthController:
public function testException()
{
    $type = $_GET['type'] ?? 'generic';
    
    switch ($type) {
        case 'validation':
            throw new ValidationException('Test validation error', [
                'field1' => 'This field has an error',
                'field2' => 'This field also has an error'
            ]);
            
        case 'database':
            throw new DatabaseException('Test database error');
            
        case 'notfound':
            throw new NotFoundException('Test resource not found');
            
        case 'authentication':
            throw new AuthenticationException('Test authentication error');
            
        default:
            throw new \Exception('Test generic exception');
    }
}</code></pre>
            </section>

            <section class="best-practices">
                <h2>✅ Exception Handling Best Practices</h2>
                
                <div class="practice">
                    <h3>🎯 Use Specific Exception Types</h3>
                    <pre><code class="language-php">// ✅ Good - Specific exception with context
if (!$user) {
    throw new NotFoundException('User not found');
}

if (!$this->validatePassword($password)) {
    throw new AuthenticationException('Invalid password');
}

// ❌ Bad - Generic exception
if (!$user) {
    throw new \Exception('Error');
}</code></pre>
                </div>

                <div class="practice">
                    <h3>📝 Provide Meaningful Messages</h3>
                    <pre><code class="language-php">// ✅ Good - Clear, actionable messages  
throw new ValidationException('Email validation failed', [
    'email' => 'Email address must be valid and unique'
]);

// ❌ Bad - Vague messages
throw new ValidationException('Invalid input');</code></pre>
                </div>

                <div class="practice">
                    <h3>🔒 Don't Expose Sensitive Information</h3>
                    <pre><code class="language-php">// ✅ Good - Safe error message
try {
    $result = $this->chargePaymentGateway($amount, $cardToken);
} catch (\Exception $e) {
    // Log the detailed error
    error_log("Payment gateway error: " . $e->getMessage());
    
    // Return safe message to client
    throw new PaymentException('Payment processing failed');
}

// ❌ Bad - Exposing internal details  
throw new PaymentException($gatewayResponse->getDetailedError());</code></pre>
                </div>

                <div class="practice">
                    <h3>📊 Log Important Exceptions</h3>
                    <pre><code class="language-php">// Log critical errors for monitoring
try {
    $this->processPayment($paymentData);
} catch (PaymentException $e) {
    // Log payment failures for business monitoring
    error_log("PAYMENT_FAILURE: " . json_encode([
        'user_id' => $userId,
        'amount' => $paymentData['amount'],
        'error' => $e->getMessage(),
        'timestamp' => time()
    ]));
    
    throw $e;
}</code></pre>
                </div>
            </section>

            <section class="next-steps">
                <h2>🎯 Next Steps</h2>
                <div class="next-links">
                    <a href="examples.html" class="next-link">
                        <strong>📚 Complete Examples</strong>
                        <span>See exception handling in real-world examples</span>
                    </a>
                    <a href="reference.html" class="next-link">
                        <strong>📖 API Reference</strong>
                        <span>Complete reference for all exception classes</span>
                    </a>
                </div>
            </section>
        </div>
    </main>

    <script src="assets/script.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
</body>
</html>
